---
alwaysApply: false
---

# Tuist Integration & Modular Workspace (AIUsageTracker)

This note documents how the AIUsageTracker workspace is generated with Tuist, how the feature packages are wired together, and the common pitfalls we have seen while maintaining the project.

## Single source of truth
- Declare every local Swift Package only in `Project.swift` under the `packages` node.
- Do **not** mirror those declarations inside `Tuist/Dependencies.swift`; duplicating the definitions causes Tuist/SwiftPM to resolve the same package twice and Xcode will render it as a plain folder instead of a package.
- App target dependencies should reference packages via `.package(product:)` only.
- Generate the workspace with `make generate`; clear derived data/cache for this project with `make clear`.

Example excerpt from `Project.swift`:
```swift
packages: [
    .local(path: "Packages/AIUsageTrackerCore"),
    .local(path: "Packages/AIUsageTrackerModel"),
    .local(path: "Packages/AIUsageTrackerAPI"),
    .local(path: "Packages/AIUsageTrackerLoginUI"),
    .local(path: "Packages/AIUsageTrackerMenuUI"),
    .local(path: "Packages/AIUsageTrackerSettingsUI"),
    .local(path: "Packages/AIUsageTrackerAppEnvironment"),
    .local(path: "Packages/AIUsageTrackerStorage"),
    .local(path: "Packages/AIUsageTrackerShareUI"),
]
```

## UI dependency injection (see also `project.mdc`)
- The project follows a SwiftUI-first Model-View approach—no global MVVM/ViewModel layer.
- Use `@Environment` to surface cross-module services:
  - `AIUsageTrackerModel` provides `EnvironmentValues.cursorStorage`.
  - `AIUsageTrackerMenuUI` exposes `cursorService`, `loginWindowManager`, and `settingsWindowManager` environment keys.
- App bootstrap injection:
```swift
MenuPopoverView()
    .environment(\.cursorService, DefaultCursorService())
    .environment(\.cursorStorage, CursorStorage.shared)
    .environment(\.loginWindowManager, LoginWindowManager.shared)
    .environment(\.settingsWindowManager, SettingsWindowManager.shared)
```
- Usage inside views:
```swift
@Environment(\.cursorService) private var service
@Environment(\.cursorStorage) private var storage
@Environment(\.loginWindowManager) private var loginWindow
@Environment(\.settingsWindowManager) private var settingsWindow
```

## Feature package checklist
- Single responsibility per package:
  - `AIUsageTrackerLoginUI`: login window & flows
  - `AIUsageTrackerMenuUI`: menu popover UI and menu logic
  - `AIUsageTrackerSettingsUI`: settings window & advanced configuration
- Every package must include a `Tests/<TargetName>Tests/` directory (a placeholder test file is fine) so Tuist/SwiftPM can generate the test target without errors.

## Common issues & fixes
- **Package shows as a plain folder with a question mark in Xcode**
  - Cause: the package was declared both in `Project.swift` and `Tuist/Dependencies.swift`, or stale SwiftPM cache.
  - Fix: remove local package entries from `Tuist/Dependencies.swift` (we keep the file empty for this reason), delete residual `.swiftpm/` directories in the packages, run `make clear`, then `make generate`.

- **"Couldn't load project at …/.swiftpm/xcode"**
  - Cause: Xcode/Tuist is picking up an outdated embedded project cache.
  - Fix: delete the affected package's `.swiftpm/` folder and regenerate.

- **`no such module 'X'`**
  - Cause: missing dependency declaration or missing `.local(path:)` entry.
  - Fix: add the package to `Project.swift` and reference the product via `.package(product:)` in the app target; regenerate the workspace.

- **Capture list errors such as `[weak _ = service]`**
  - Swift does not allow anonymous weak captures. Remove the capture, store the `Task` handle instead, and cancel it when appropriate.

## Tuist make targets
- Generate the workspace
```bash
make generate
```
- Clear derived data and Tuist cache for this project
```bash
make clear
```

## Adding a new feature package
1. Create `Packages/<Feature>/Package.swift`, `Sources/<Feature>/`, and `Tests/<Feature>Tests/`.
2. Declare the package product/dependencies inside the new `Package.swift`.
3. Add `.local(path: "Packages/<Feature>")` to `Project.swift` and reference the product from the app target.
4. Run `make generate` again.

> Tip: maintaining a single source of truth in `Project.swift` dramatically reduces Tuist/SwiftPM cache issues.
