---
alwaysApply: true
---
# Project Overview

See also Tuist/modularization details: `.cursor/rules/tuist.mdc`
See architecture conventions: `.cursor/rules/architecture.mdc`

AIUsageTracker is a **macOS 14+ menu-bar application** written in **Swift 5.10** with **SwiftUI**. The workspace is generated through **Tuist** and is composed of multiple Swift Packages that keep networking, storage, analytics, and UI concerns isolated.

- **Frameworks & Tech**: SwiftUI for UI, Swift Concurrency (async/await, actors, @MainActor), Combine-free implementation, Swift Package Manager for modularization.
- **Architecture**: Model-View (pure SwiftUI) with dependency injection through `@Environment`. We intentionally avoid a global MVVM/ViewModel layer.
- **Testing**: Each package ships an independent `Tests/` target. Some packages rely on macOS-only frameworks; run their tests on macOS.
- **Platform target**: macOS (menu-bar app launched via `@main` app struct).
- **Accessibility**: Views should include appropriate accessibility labels, values, and hints when applicable.

## Workspace structure
```
AIUsageTracker/
├── AIUsageTracker/                  # App shell (Assets + @main entry)
├── Packages/
│   ├── AIUsageTrackerCore/          # Shared utilities & services
│   ├── AIUsageTrackerModel/         # Domain models & value types
│   ├── AIUsageTrackerAPI/           # Networking + DTO→domain mapping
│   ├── AIUsageTrackerAppEnvironment/# Environment wiring & background services
│   ├── AIUsageTrackerStorage/       # Persistence, credential store, proxy ingestion
│   ├── AIUsageTrackerLoginUI/       # Login window feature
│   ├── AIUsageTrackerMenuUI/        # Menu popover feature
│   ├── AIUsageTrackerSettingsUI/    # Settings window feature
│   └── AIUsageTrackerShareUI/       # Share/export components
├── docs/                            # Documentation
├── Scripts/                         # Tuist helpers, DMG packaging
└── Makefile                         # Common developer commands
```

The app target simply composes these packages; all business logic lives inside the Swift Packages.

## Code quality & style
- Use `UpperCamelCase` for types and `lowerCamelCase` for members and functions.
- Prefer value types (`struct`, `enum`) and keep them `Sendable` when crossing concurrency domains.
- Side effects live inside SwiftUI `.task`/`.onChange` modifiers and cancel automatically with view lifecycle.
- Handle optionals safely with `guard`/`if let`; avoid force unwraps.
- Errors should be meaningful `Error`-conforming types and handled or surfaced to the caller.

## SwiftUI guidance
1. **Views describe state**
   ```swift
   struct UsageView: View {
       @Environment(\.usageRefreshService) private var refresh
       @State private var viewState: ViewState = .loading

       enum ViewState {
           case loading
           case loaded(DashboardSnapshot)
           case error(String)
       }

       var body: some View {
           // Render based on `viewState`
       }
   }
   ```
2. **Dependency injection**
   - App-wide services (storage, refresh, window managers) come from `@Environment` keys defined in their respective packages.
   - Feature-specific helpers can be stored as `let` properties or dedicated `@Observable` objects local to the feature.
3. **Local state management**
   - Use `@State`/`@Binding` for simple values.
   - Promote reusable logic into smaller subviews or `View` extensions.
4. **Avoid monolithic view controllers**
   - Break complex UI into smaller composable views.
   - Keep the menu popover responsive; avoid synchronous work on the main thread.

## Tooling
- Generate workspace: `make generate`
- Clean caches: `make clear`
- Release workflow: `make release` (clean → generate → build → package)

## Platform notes
- The app relies on macOS Keychain for credential storage—ensure tests that touch it run on macOS.
- Some packages use ServiceManagement/NotificationCenter APIs available only on macOS.
- When adding new macOS-specific functionality, guard availability where appropriate to keep Linux builds from failing.
